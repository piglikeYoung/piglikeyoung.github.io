
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  
    <title>AFURLSerialization è§£æï¼ˆå››ï¼‰ | Pixar&#39;Filed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Pixar">
    

    
    <meta name="description" content="å‰è¨€å‰é¢çš„æ–‡å­—å·²ç»åˆ†æäº† AFURLSessionManager å’Œ AFNetworkReachabilityManagerï¼Œä¸€ä¸ªæ˜¯ AFN çš„æ ¸å¿ƒï¼Œå¦ä¸€ä¸ªæ˜¯ AFN éå¸¸æœ‰ç”¨çš„å·¥å…·ç±»ã€‚ è¿™é‡Œæˆ‘ä»¬æ¥ç€äº†è§£ AFURLSessionManager ä¸­ä½¿ç”¨åˆ°çš„å¯¹å‘å‡ºè¯·æ±‚å’Œæ¥æ”¶å“åº”æ—¶è¿›è¡Œåºåˆ—åŒ–çš„ä¸¤ä¸ªæ¨¡å—ï¼š  AFURLResponseSerialization AFURLRequestSerializ">
<meta name="keywords" content="AFNetworking">
<meta property="og:type" content="article">
<meta property="og:title" content="AFURLSerialization è§£æï¼ˆå››ï¼‰">
<meta property="og:url" content="http://piglikeyoung.com/2017/01/08/AFNetworking-AFURLSerialization-4/index.html">
<meta property="og:site_name" content="Pixar&#39;Filed">
<meta property="og:description" content="å‰è¨€å‰é¢çš„æ–‡å­—å·²ç»åˆ†æäº† AFURLSessionManager å’Œ AFNetworkReachabilityManagerï¼Œä¸€ä¸ªæ˜¯ AFN çš„æ ¸å¿ƒï¼Œå¦ä¸€ä¸ªæ˜¯ AFN éå¸¸æœ‰ç”¨çš„å·¥å…·ç±»ã€‚ è¿™é‡Œæˆ‘ä»¬æ¥ç€äº†è§£ AFURLSessionManager ä¸­ä½¿ç”¨åˆ°çš„å¯¹å‘å‡ºè¯·æ±‚å’Œæ¥æ”¶å“åº”æ—¶è¿›è¡Œåºåˆ—åŒ–çš„ä¸¤ä¸ªæ¨¡å—ï¼š  AFURLResponseSerialization AFURLRequestSerializ">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://piglikeyoung.com/2017/01/08/AFNetworking-AFURLSerialization-4/Snip20170126_3.png">
<meta property="og:updated_time" content="2017-01-26T13:39:31.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AFURLSerialization è§£æï¼ˆå››ï¼‰">
<meta name="twitter:description" content="å‰è¨€å‰é¢çš„æ–‡å­—å·²ç»åˆ†æäº† AFURLSessionManager å’Œ AFNetworkReachabilityManagerï¼Œä¸€ä¸ªæ˜¯ AFN çš„æ ¸å¿ƒï¼Œå¦ä¸€ä¸ªæ˜¯ AFN éå¸¸æœ‰ç”¨çš„å·¥å…·ç±»ã€‚ è¿™é‡Œæˆ‘ä»¬æ¥ç€äº†è§£ AFURLSessionManager ä¸­ä½¿ç”¨åˆ°çš„å¯¹å‘å‡ºè¯·æ±‚å’Œæ¥æ”¶å“åº”æ—¶è¿›è¡Œåºåˆ—åŒ–çš„ä¸¤ä¸ªæ¨¡å—ï¼š  AFURLResponseSerialization AFURLRequestSerializ">
<meta name="twitter:image" content="http://piglikeyoung.com/2017/01/08/AFNetworking-AFURLSerialization-4/Snip20170126_3.png">

    
    <link rel="alternative" href="/atom.xml" title="Pixar&#39;Filed" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="stylesheet" href="/css/style.css">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Pixar&#39;Filed">Pixar&#39;Filed</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">ä¸»é¡µ</a></li>
					
						<li><a href="/archives">å½’æ¡£</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="æœç´¢">
						<input type="hidden" name="q" value="site:piglikeyoung.com">
					</form>
					
					</li>
				</ul>
			</ul></nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/08/AFNetworking-AFURLSerialization-4/" title="AFURLSerialization è§£æï¼ˆå››ï¼‰" itemprop="url">AFURLSerialization è§£æï¼ˆå››ï¼‰</a>
  </h1>
  <p class="article-time">
    <time datetime="2017-01-08T09:55:59.000Z" itemprop="datePublished"> å‘è¡¨äº 2017-01-08</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">æ–‡ç« ç›®å½•</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#å‰è¨€"><span class="toc-number">1.</span> <span class="toc-text">å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AFURLResponseSerialization"><span class="toc-number">2.</span> <span class="toc-text">AFURLResponseSerialization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AFHTTPResponseSerializer"><span class="toc-number">3.</span> <span class="toc-text">AFHTTPResponseSerializer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#åˆå§‹åŒ–"><span class="toc-number">3.1.</span> <span class="toc-text">åˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#éªŒè¯å“åº”"><span class="toc-number">3.2.</span> <span class="toc-text">éªŒè¯å“åº”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å®ç°åè®®"><span class="toc-number">3.3.</span> <span class="toc-text">å®ç°åè®®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NSSecureCodingï¼ŒNSCopying"><span class="toc-number">3.4.</span> <span class="toc-text">NSSecureCodingï¼ŒNSCopying</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AFJSONResponseSerializer"><span class="toc-number">4.</span> <span class="toc-text">AFJSONResponseSerializer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#åˆå§‹åŒ–-1"><span class="toc-number">4.1.</span> <span class="toc-text">åˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å®ç°åè®®-1"><span class="toc-number">4.2.</span> <span class="toc-text">å®ç°åè®®</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AFURLRequestSerialization"><span class="toc-number">5.</span> <span class="toc-text">AFURLRequestSerialization</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å¤„ç†è¯·æ±‚å‚æ•°"><span class="toc-number">5.1.</span> <span class="toc-text">å¤„ç†è¯·æ±‚å‚æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è®¾ç½®-HTTP-è¯·æ±‚å¤´"><span class="toc-number">5.2.</span> <span class="toc-text">è®¾ç½® HTTP è¯·æ±‚å¤´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è®¾ç½®è¯·æ±‚URLçš„å±æ€§"><span class="toc-number">5.3.</span> <span class="toc-text">è®¾ç½®è¯·æ±‚URLçš„å±æ€§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åˆå§‹åŒ–-2"><span class="toc-number">5.4.</span> <span class="toc-text">åˆå§‹åŒ–</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">6.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒé“¾æ¥"><span class="toc-number">7.</span> <span class="toc-text">å‚è€ƒé“¾æ¥</span></a></li></ol>
		
		</div>
		
		<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰é¢çš„æ–‡å­—å·²ç»åˆ†æäº† <strong>AFURLSessionManager</strong> å’Œ <strong>AFNetworkReachabilityManager</strong>ï¼Œä¸€ä¸ªæ˜¯ AFN çš„æ ¸å¿ƒï¼Œå¦ä¸€ä¸ªæ˜¯ AFN éå¸¸æœ‰ç”¨çš„å·¥å…·ç±»ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æ¥ç€äº†è§£ AFURLSessionManager ä¸­ä½¿ç”¨åˆ°çš„<strong>å¯¹å‘å‡ºè¯·æ±‚å’Œæ¥æ”¶å“åº”æ—¶</strong>è¿›è¡Œåºåˆ—åŒ–çš„ä¸¤ä¸ªæ¨¡å—ï¼š</p>
<ul>
<li>AFURLResponseSerialization</li>
<li>AFURLRequestSerialization</li>
</ul>
<p>å‰è€…æ˜¯å¤„ç†å“åº”çš„æ¨¡å—ï¼Œå°†è¯·æ±‚è¿”å›çš„æ•°æ®è§£ææˆå¯¹ç”¨çš„æ ¼å¼ã€‚åè€…ä¸»è¦æ˜¯ä¿®æ”¹è¯·æ±‚çš„å¤´éƒ¨ï¼ˆä¸»è¦æ˜¯ HTTP è¯·æ±‚ï¼‰ã€‚</p>
<p>AFURLResponseSerialization ä¸»è¦ä½¿ç”¨åœ¨ AFURLSessionManager ä¸­ï¼Œè€Œ AFURLRequestSerialization ä¸»è¦ç”¨äº AFHTTPSessionManager ä¸­ï¼Œå› ä¸ºå®ƒä¸»è¦ç”¨äº<strong>ä¿®æ”¹ HTTP å¤´éƒ¨</strong>ã€‚</p>
<h2 id="AFURLResponseSerialization"><a href="#AFURLResponseSerialization" class="headerlink" title="AFURLResponseSerialization"></a>AFURLResponseSerialization</h2><p>AFURLResponseSerialization å…¶å®å¹¶ä¸æ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒæ˜¯ä¸ªåè®®ï¼Œå®ƒåªæœ‰ä¸€ä¸ªéœ€è¦å®ç°çš„æ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">AFURLResponseSerialization</span> &lt;<span class="title">NSObject</span>, <span class="title">NSSecureCoding</span>, <span class="title">NSCopying</span>&gt;</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)responseObjectForResponse:(<span class="keyword">nullable</span> <span class="built_in">NSURLResponse</span> *)response</span><br><span class="line">                           data:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)data</span><br><span class="line">                          error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error <span class="built_in">NS_SWIFT_NOTHROW</span>;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>éµå¾ªè¿™ä¸ªåè®®çš„åŒæ—¶ä¹Ÿéœ€è¦éµå¾ª NSObject, NSSecureCoding å’Œ NSCopying è¿™ä¸‰ä¸ªåè®®ï¼Œå®ç°å®‰å…¨ç¼–ç ã€æ‹·è´ä»¥åŠObjective-C å¯¹è±¡çš„åŸºæœ¬è¡Œä¸ºã€‚</p>
<p>å…ˆäº†è§£ä¸‹ AFURLResponseSerialization çš„æ¨¡å‹ç»“æ„ï¼š<br><img src="/2017/01/08/AFNetworking-AFURLSerialization-4/Snip20170126_3.png" title="AFURLResponseSerialization"></p>
<ul>
<li>AFHTTPResponseSerializer æ˜¯æ¨¡å‹ä¸­æ‰€æœ‰Serializerçš„æ ¹ç±»</li>
<li>æ‰€æœ‰Serializer éƒ½éœ€è¦éµå¾ª AFURLResponseSerialization åè®®</li>
</ul>
<h2 id="AFHTTPResponseSerializer"><a href="#AFHTTPResponseSerializer" class="headerlink" title="AFHTTPResponseSerializer"></a>AFHTTPResponseSerializer</h2><p>AFHTTPResponseSerializer æ˜¯æ‰€æœ‰å“åº”è§£æçš„æ ¹ç±»ï¼Œå› ä¸ºå®ƒéµå¾ªäº† AFURLResponseSerialization åè®®ï¼Œæ‰€ä»¥å­ç±»ä¹Ÿè¦éµå¾ªã€‚</p>
<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)serializer &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.acceptableStatusCodes = [<span class="built_in">NSIndexSet</span> indexSetWithIndexesInRange:<span class="built_in">NSMakeRange</span>(<span class="number">200</span>, <span class="number">100</span>)];</span><br><span class="line">    <span class="keyword">self</span>.acceptableContentTypes = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>acceptableStatusCodes è®¾ç½®ä¸ºä» 200 åˆ° 299 ä¹‹é—´çš„çŠ¶æ€ç , å› ä¸ºåªæœ‰è¿™äº›çŠ¶æ€ç è¡¨ç¤ºè·å¾—äº†æœ‰æ•ˆçš„å“åº”ã€‚</p>
<h3 id="éªŒè¯å“åº”"><a href="#éªŒè¯å“åº”" class="headerlink" title="éªŒè¯å“åº”"></a>éªŒè¯å“åº”</h3><p>AFHTTPResponseSerializer æœ€é‡è¦çš„æ–¹æ³• <strong>- [AFHTTPResponseSerializer validateResponse:data:error:]</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)validateResponse:(<span class="built_in">NSHTTPURLResponse</span> *)response</span><br><span class="line">                    data:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                   error:(<span class="built_in">NSError</span> * __autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">BOOL</span> responseIsValid = <span class="literal">YES</span>;</span><br><span class="line">    <span class="built_in">NSError</span> *validationError = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (response &amp;&amp; [response isKindOfClass:[<span class="built_in">NSHTTPURLResponse</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.acceptableContentTypes &amp;&amp; ![<span class="keyword">self</span>.acceptableContentTypes containsObject:[response MIMEType]] &amp;&amp;</span><br><span class="line">            !([response MIMEType] == <span class="literal">nil</span> &amp;&amp; [data length] == <span class="number">0</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">#1: è¿”å›çš„æ•°æ®ç±»å‹æ— æ•ˆ</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.acceptableStatusCodes &amp;&amp; ![<span class="keyword">self</span>.acceptableStatusCodes containsIndex:(<span class="built_in">NSUInteger</span>)response.statusCode] &amp;&amp; [response URL]) &#123;</span><br><span class="line">            <span class="meta">#2: è¿”å›çš„çŠ¶æ€ç æ— æ•ˆ</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error &amp;&amp; !responseIsValid) &#123;</span><br><span class="line">        *error = validationError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> responseIsValid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">self</span>.acceptableContentTypes &amp;&amp; ![<span class="keyword">self</span>.acceptableContentTypes containsObject:[response MIMEType]] &amp;&amp;</span><br><span class="line">            !([response MIMEType] == <span class="literal">nil</span> &amp;&amp; [data length] == <span class="number">0</span>)) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ([data length] &gt; <span class="number">0</span> &amp;&amp; [response URL]) &#123;</span><br><span class="line">      <span class="built_in">NSMutableDictionary</span> *mutableUserInfo = [@&#123;</span><br><span class="line">                                                <span class="built_in">NSLocalizedDescriptionKey</span>: [<span class="built_in">NSString</span> stringWithFormat:<span class="built_in">NSLocalizedStringFromTable</span>(<span class="string">@"Request failed: unacceptable content-type: %@"</span>, <span class="string">@"AFNetworking"</span>, <span class="literal">nil</span>), [response MIMEType]],</span><br><span class="line">                                                <span class="built_in">NSURLErrorFailingURLErrorKey</span>:[response URL],</span><br><span class="line">                                                AFNetworkingOperationFailingURLResponseErrorKey: response,</span><br><span class="line">                                              &#125; mutableCopy];</span><br><span class="line">      <span class="keyword">if</span> (data) &#123;</span><br><span class="line">          mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      validationError = AFErrorWithUnderlyingError([<span class="built_in">NSError</span> errorWithDomain:AFURLResponseSerializationErrorDomain code:<span class="built_in">NSURLErrorCannotDecodeContentData</span> userInfo:mutableUserInfo], validationError);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  responseIsValid = <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å…ˆåˆ¤æ–­ acceptableContentTypes é›†åˆé‡Œé¢æ˜¯å¦åŒ…å«å“åº”ç±»å‹ï¼Œå¦‚æœä¸åŒ…å«è¿›å…¥ if</li>
<li>åœ¨ if é‡Œé¢é€šè¿‡ AFErrorWithUnderlyingError åŒ…è£…é”™è¯¯ä¿¡æ¯ï¼Œæœ€åè®¾ç½® responseIsValid = NO</li>
</ul>
<p>ç¬¬äºŒæ®µä»£ç ä¹Ÿæ˜¯å·®ä¸å¤šçš„å®ç°ã€‚</p>
<h3 id="å®ç°åè®®"><a href="#å®ç°åè®®" class="headerlink" title="å®ç°åè®®"></a>å®ç°åè®®</h3><p>å…¶å®å°±æ˜¯è°ƒç”¨ğŸ‘†çš„éªŒè¯æ–¹æ³•ï¼Œç„¶åè¿”å›æ•°æ®<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)responseObjectForResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line">                           data:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> validateResponse:(<span class="built_in">NSHTTPURLResponse</span> *)response data:data error:error];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="NSSecureCodingï¼ŒNSCopying"><a href="#NSSecureCodingï¼ŒNSCopying" class="headerlink" title="NSSecureCodingï¼ŒNSCopying"></a>NSSecureCodingï¼ŒNSCopying</h3><p>æœ€åæ˜¯å®ç° NSSecureCodingï¼ŒNSCopying è¿™ä¸¤ä¸ªåè®®ï¼Œæ²¡ä»€ä¹ˆå¥½è¯´çš„ã€‚</p>
<h2 id="AFJSONResponseSerializer"><a href="#AFJSONResponseSerializer" class="headerlink" title="AFJSONResponseSerializer"></a>AFJSONResponseSerializer</h2><p>ç°åœ¨çœ‹ä¸‹ AFJSONResponseSerializer ï¼Œå®ƒç»§æ‰¿è‡ª AFHTTPResponseSerializerã€‚</p>
<h3 id="åˆå§‹åŒ–-1"><a href="#åˆå§‹åŒ–-1" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>è°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–åï¼Œå¢åŠ äº† acceptableContentTypes èµ‹å€¼</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.acceptableContentTypes = [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"application/json"</span>, <span class="string">@"text/json"</span>, <span class="string">@"text/javascript"</span>, <span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<h3 id="å®ç°åè®®-1"><a href="#å®ç°åè®®-1" class="headerlink" title="å®ç°åè®®"></a>å®ç°åè®®</h3><p>è¿™ä¸ªå­ç±»å¯¹ AFURLResponseSerialization åè®®å®ç°æ¯”çˆ¶ç±»å¤æ‚å¾—å¤š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)responseObjectForResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line">                           data:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">	  <span class="comment">// å»çˆ¶ç±»éªŒè¯å“åº”æœ‰æ•ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (![<span class="keyword">self</span> validateResponse:(<span class="built_in">NSHTTPURLResponse</span> *)response data:data error:error]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!error || AFErrorOrUnderlyingErrorHasCodeInDomain(*error, <span class="built_in">NSURLErrorCannotDecodeContentData</span>, AFURLResponseSerializationErrorDomain)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Workaround for behavior of Rails to return a single space for `head :ok` (a workaround for a bug in Safari), which is not interpreted as valid input by NSJSONSerialization.</span></span><br><span class="line">    <span class="comment">// See https://github.com/rails/rails/issues/1742</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è§£å†³åªæœ‰ä¸€ä¸ªç©ºæ ¼å¼•èµ·çš„bug</span></span><br><span class="line">    <span class="built_in">BOOL</span> isSpace = [data isEqualToData:[<span class="built_in">NSData</span> dataWithBytes:<span class="string">" "</span> length:<span class="number">1</span>]];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (data.length == <span class="number">0</span> || isSpace) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–JSON</span></span><br><span class="line">    <span class="keyword">id</span> responseObject = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:data options:<span class="keyword">self</span>.readingOptions error:&amp;serializationError];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!responseObject)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            *error = AFErrorWithUnderlyingError(serializationError, *error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// JSONæ˜¯å¦ç§»é™¤ â€˜NSNullâ€™ é»˜è®¤æ˜¯ NO</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.removesKeysWithNullValues) &#123;</span><br><span class="line">        <span class="keyword">return</span> AFJSONObjectByRemovingKeysWithNullValues(responseObject, <span class="keyword">self</span>.readingOptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> responseObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç§»é™¤ JSON ä¸­ null çš„å‡½æ•° AFJSONObjectByRemovingKeysWithNullValues æ˜¯ä¸€ä¸ªé€’å½’è°ƒç”¨çš„å‡½æ•°ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> AFJSONObjectByRemovingKeysWithNullValues(<span class="keyword">id</span> JSONObject, <span class="built_in">NSJSONReadingOptions</span> readingOptions) &#123;</span><br><span class="line">    <span class="keyword">if</span> ([JSONObject isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSMutableArray</span> *mutableArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:[(<span class="built_in">NSArray</span> *)JSONObject count]];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> value <span class="keyword">in</span> (<span class="built_in">NSArray</span> *)JSONObject) &#123;</span><br><span class="line">            [mutableArray addObject:AFJSONObjectByRemovingKeysWithNullValues(value, readingOptions)];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (readingOptions &amp; <span class="built_in">NSJSONReadingMutableContainers</span>) ? mutableArray : [<span class="built_in">NSArray</span> arrayWithArray:mutableArray];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([JSONObject isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSMutableDictionary</span> *mutableDictionary = [<span class="built_in">NSMutableDictionary</span> dictionaryWithDictionary:JSONObject];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> &lt;<span class="built_in">NSCopying</span>&gt; key <span class="keyword">in</span> [(<span class="built_in">NSDictionary</span> *)JSONObject allKeys]) &#123;</span><br><span class="line">            <span class="keyword">id</span> value = (<span class="built_in">NSDictionary</span> *)JSONObject[key];</span><br><span class="line">            <span class="keyword">if</span> (!value || [value isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</span><br><span class="line">                [mutableDictionary removeObjectForKey:key];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]] || [value isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                mutableDictionary[key] = AFJSONObjectByRemovingKeysWithNullValues(value, readingOptions);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (readingOptions &amp; <span class="built_in">NSJSONReadingMutableContainers</span>) ? mutableDictionary : [<span class="built_in">NSDictionary</span> dictionaryWithDictionary:mutableDictionary];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> JSONObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ–¹æ³•ä¸­åˆ¤æ–­ç±»å‹æ˜¯ NSArray è¿˜æ˜¯ NSDictionaryï¼Œåªæœ‰ NSDictionary ä¸­å­˜åœ¨ â€˜nullâ€™ï¼Œæ‰€æœ‰ç§»é™¤æ˜¯é  <strong>[mutableDictionary removeObjectForKey:key];</strong></p>
<h2 id="AFURLRequestSerialization"><a href="#AFURLRequestSerialization" class="headerlink" title="AFURLRequestSerialization"></a>AFURLRequestSerialization</h2><p>AFURLRequestSerialization ç›¸å¯¹å¤æ‚äº›ï¼Œå®ƒçš„ä¸»è¦å·¥ä½œæ˜¯å¯¹å‘å‡ºçš„ HTTP è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚<br>è¿™ä¸ªæ–‡ä»¶ä¸­å¤§éƒ¨åˆ†ç±»éƒ½æ˜¯ä¸º AFHTTPRequestSerializer æœåŠ¡çš„ï¼š</p>
<ol>
<li>å¤„ç†è¯·æ±‚å‚æ•°</li>
<li>è®¾ç½® HTTP è¯·æ±‚å¤´</li>
<li>è®¾ç½®è¯·æ±‚URLçš„å±æ€§</li>
<li>åˆ†å—ä¸Šä¼ </li>
</ol>
<blockquote>
<p>åˆ†å—ä¸Šä¼ ç›¸å¯¹å¤æ‚å¾—å¤šï¼Œæœ‰å…´è¶£çš„å¯ä»¥å»ç ”ç©¶ä¸‹ï¼Œè¿™é‡Œä¸è¿›è¡Œç»†è®²</p>
</blockquote>
<h3 id="å¤„ç†è¯·æ±‚å‚æ•°"><a href="#å¤„ç†è¯·æ±‚å‚æ•°" class="headerlink" title="å¤„ç†è¯·æ±‚å‚æ•°"></a>å¤„ç†è¯·æ±‚å‚æ•°</h3><p>è®¾ç½®æŸ¥è¯¢å‚æ•°ä¸»è¦æ˜¯é€šè¿‡ <strong>AFQueryStringPair</strong> å®Œæˆï¼Œå®ƒæœ‰ä¸¤ä¸ªå±æ€§ field å’Œ value å¯¹åº”HTTP è¯·æ±‚çš„æŸ¥è¯¢ URL ä¸­çš„å‚æ•°ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFQueryStringPair</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> field;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> value;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithField:(<span class="keyword">id</span>)field value:(<span class="keyword">id</span>)value;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)URLEncodedStringValue;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <strong>- [AFQueryStringPair URLEncodedStringValue]</strong> ä¼šè¿”å› <strong>key=value</strong> è¿™ç§æ ¼å¼ï¼ŒåŒæ—¶ä½¿ç”¨ <strong>AFPercentEscapedStringFromString</strong> å‡½æ•°æ¥å¯¹ field å’Œ value è¿›è¡Œå¤„ç†ï¼Œå°†å…¶ä¸­çš„ :#[]@!$&amp;â€™()*+,;= ç­‰å­—ç¬¦è½¬æ¢ä¸ºç™¾åˆ†å·è¡¨ç¤ºçš„å½¢å¼ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)URLEncodedStringValue &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.value || [<span class="keyword">self</span>.value isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> AFPercentEscapedStringFromString([<span class="keyword">self</span>.field description]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@=%@"</span>, AFPercentEscapedStringFromString([<span class="keyword">self</span>.field description]), AFPercentEscapedStringFromString([<span class="keyword">self</span>.value description])];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>AFQueryStringPairsFromKeyAndValue</strong> æ–¹æ³•ï¼Œå¦‚æœ value æ˜¯é›†åˆç±»å‹ï¼Œå®ƒä¼šä¸æ–­é€’å½’è°ƒç”¨è‡ªå·±ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> * AFQueryStringPairsFromKeyAndValue(<span class="built_in">NSString</span> *key, <span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutableQueryStringComponents = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSSortDescriptor</span> *sortDescriptor = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"description"</span> ascending:<span class="literal">YES</span> selector:<span class="keyword">@selector</span>(compare:)];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *dictionary = value;</span><br><span class="line">        <span class="comment">// Sort dictionary keys to ensure consistent ordering in query string, which is important when deserializing potentially ambiguous sequences, such as an array of dictionaries</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> nestedKey <span class="keyword">in</span> [dictionary.allKeys sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</span><br><span class="line">            <span class="keyword">id</span> nestedValue = dictionary[nestedKey];</span><br><span class="line">            <span class="keyword">if</span> (nestedValue) &#123;</span><br><span class="line">                [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue((key ? [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@[%@]"</span>, key, nestedKey] : nestedKey), nestedValue)];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *array = value;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> nestedValue <span class="keyword">in</span> array) &#123;</span><br><span class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue([<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@[]"</span>, key], nestedValue)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSSet</span> *set = value;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> [set sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</span><br><span class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue(key, obj)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸æ˜¯é›†åˆç±»å‹ï¼Œå°±åˆ›å»º AFQueryStringPair å¯¹è±¡ï¼Œæ·»åŠ åˆ°æ•°ç»„</span></span><br><span class="line">        [mutableQueryStringComponents addObject:[[AFQueryStringPair alloc] initWithField:key value:value]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mutableQueryStringComponents;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åä¼šè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œé¢æ˜¯ä¸€ä¸ªä¸ª AFQueryStringPair å¯¹è±¡ã€‚</p>
<p>å¾—åˆ°æ•°ç»„åä¼šè°ƒç”¨ <strong>AFQueryStringFromParameters</strong> ä½¿ç”¨ <strong>&amp;</strong> æ¥æ‹¼æ¥å®ƒä»¬ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> * AFQueryStringFromParameters(<span class="built_in">NSDictionary</span> *parameters) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutablePairs = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">for</span> (AFQueryStringPair *pair <span class="keyword">in</span> AFQueryStringPairsFromDictionary(parameters)) &#123;</span><br><span class="line">        [mutablePairs addObject:[pair URLEncodedStringValue]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [mutablePairs componentsJoinedByString:<span class="string">@"&amp;"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆå¾—åˆ°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=haha&amp;password=123456</span><br></pre></td></tr></table></figure>
<h3 id="è®¾ç½®-HTTP-è¯·æ±‚å¤´"><a href="#è®¾ç½®-HTTP-è¯·æ±‚å¤´" class="headerlink" title="è®¾ç½® HTTP è¯·æ±‚å¤´"></a>è®¾ç½® HTTP è¯·æ±‚å¤´</h3><p>AFHTTPRequestSerializer å¯¹å¤–æä¾›äº† <strong>- [AFHTTPRequestSerializer setValue:forHTTPHeaderField:]</strong> æ–¹æ³•æ¥è®¾ç½®è¯·æ±‚å¤´ï¼Œå†…éƒ¨å®ç°æ˜¯é€šè¿‡ç»™ä¸€ä¸ªå¯å˜å­—å…¸ <strong>mutableHTTPRequestHeaders</strong> èµ‹å€¼å’Œå–å€¼è·å–ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="built_in">NSString</span> *)value</span><br><span class="line">forHTTPHeaderField:(<span class="built_in">NSString</span> *)field</span><br><span class="line">&#123;</span><br><span class="line">	[<span class="keyword">self</span>.mutableHTTPRequestHeaders setValue:value forKey:field];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)valueForHTTPHeaderField:(<span class="built_in">NSString</span> *)field &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span>.mutableHTTPRequestHeaders valueForKey:field];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœŸæ­£ç”¨åˆ°çš„æ—¶å€™åˆæ˜¯é€šè¿‡ <strong>HTTPRequestHeaders</strong> è¿™ä¸ªæ–¹æ³•è·å–ä¸å¯å˜å­—å…¸ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSDictionary</span> *)HTTPRequestHeaders &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSDictionary</span> dictionaryWithDictionary:<span class="keyword">self</span>.mutableHTTPRequestHeaders];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è®¾ç½®ä¸€èˆ¬çš„è¯·æ±‚å¤´å­—æ®µæ—¶ï¼Œå¯ä»¥å‚è€ƒ AFHTTPRequestSerializer åˆå§‹åŒ–çš„è®¾ç½®</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">userAgent = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@/%@ (%@; iOS %@; Scale/%0.2f)"</span>, [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleExecutableKey] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleIdentifierKey], [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][<span class="string">@"CFBundleShortVersionString"</span>] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleVersionKey], [[<span class="built_in">UIDevice</span> currentDevice] model], [[<span class="built_in">UIDevice</span> currentDevice] systemVersion], [[<span class="built_in">UIScreen</span> mainScreen] scale]];</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span> setValue:userAgent forHTTPHeaderField:<span class="string">@"User-Agent"</span>];</span><br></pre></td></tr></table></figure>
<p>éªŒè¯ç”¨æˆ·åå’Œå¯†ç æ—¶ï¼Œè°ƒç”¨ <strong>- [AFHTTPRequestSerializer setAuthorizationHeaderFieldWithUsername:password:]</strong>ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setAuthorizationHeaderFieldWithUsername:(<span class="built_in">NSString</span> *)username</span><br><span class="line">                                       password:(<span class="built_in">NSString</span> *)password</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSData</span> *basicAuthCredentials = [[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@:%@"</span>, username, password] dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *base64AuthCredentials = [basicAuthCredentials base64EncodedStringWithOptions:(<span class="built_in">NSDataBase64EncodingOptions</span>)<span class="number">0</span>];</span><br><span class="line">    [<span class="keyword">self</span> setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Basic %@"</span>, base64AuthCredentials] forHTTPHeaderField:<span class="string">@"Authorization"</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è®¾ç½®è¯·æ±‚URLçš„å±æ€§"><a href="#è®¾ç½®è¯·æ±‚URLçš„å±æ€§" class="headerlink" title="è®¾ç½®è¯·æ±‚URLçš„å±æ€§"></a>è®¾ç½®è¯·æ±‚URLçš„å±æ€§</h3><p>è®¾ç½®å®Œè¯·æ±‚å¤´å’Œè¯·æ±‚å‚æ•°ï¼Œè¿˜æœ‰ä¸€äº›å…³äºè¯·æ±‚çš„è®¾ç½®ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> å­—ç¬¦ä¸²ç¼–ç ï¼Œé»˜è®¤ `NSUTF8StringEncoding`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è¯·æ±‚èƒ½å¤Ÿä½¿ç”¨èœ‚çªæ— çº¿ç”µï¼Œé»˜è®¤ YES.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> allowsCellularAccess;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ç¼“å­˜ç­–ç•¥ï¼Œé»˜è®¤ `NSURLRequestUseProtocolCachePolicy`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSURLRequestCachePolicy</span> cachePolicy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è¯·æ±‚æ˜¯å¦ä½¿ç”¨é»˜è®¤çš„cookieå¤„ç†ï¼Œé»˜è®¤ `YES`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> HTTPShouldHandleCookies;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è¯·æ±‚æ˜¯å¦ä½¿ç”¨ ç®¡é“ï¼Œ é»˜è®¤ `NO` .</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> HTTPShouldUsePipelining;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ç½‘ç»œè¯·æ±‚çš„æœåŠ¡ç±»å‹ï¼Œé»˜è®¤ `NSURLNetworkServiceTypeDefault`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSURLRequestNetworkServiceType</span> networkServiceType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯ 60s.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> timeoutInterval;</span><br></pre></td></tr></table></figure>
<p>è¿™äº›å€¼ä¼šé€šè¿‡è°ƒç”¨ <strong>AFHTTPRequestSerializerObservedKeyPaths</strong> è¿”å›ä¸€ä¸ªæ•°ç»„ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * AFHTTPRequestSerializerObservedKeyPaths() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSArray</span> *_AFHTTPRequestSerializerObservedKeyPaths = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        _AFHTTPRequestSerializerObservedKeyPaths = @[<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowsCellularAccess)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldHandleCookies)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldUsePipelining)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(networkServiceType)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(timeoutInterval))];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _AFHTTPRequestSerializerObservedKeyPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AFURLRequestSerialization æ˜¯é€šè¿‡ KVOç›‘å¬è¿™äº›å€¼çš„å˜åŒ–ï¼Œå½“è¿™äº›å€¼è¢«è®¾ç½®æ—¶ï¼Œä¼šè§¦å‘KVOï¼Œç„¶åæŠŠæ–°çš„å±æ€§å­˜å‚¨åœ¨ <strong>mutableObservedChangedKeyPaths</strong> å­—å…¸ä¸­ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨æ§åˆ¶é€šçŸ¥æ–¹å¼</span></span><br><span class="line">    <span class="keyword">if</span> ([AFHTTPRequestSerializerObservedKeyPaths() containsObject:key]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é»˜è®¤è‡ªåŠ¨é€šçŸ¥</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath</span><br><span class="line">                      ofObject:(__unused <span class="keyword">id</span>)object</span><br><span class="line">                        change:(<span class="built_in">NSDictionary</span> *)change</span><br><span class="line">                       context:(<span class="keyword">void</span> *)context</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (context == AFHTTPRequestSerializerObserverContext) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([change[<span class="built_in">NSKeyValueChangeNewKey</span>] isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</span><br><span class="line">            [<span class="keyword">self</span>.mutableObservedChangedKeyPaths removeObject:keyPath];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span>.mutableObservedChangedKeyPaths addObject:keyPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ååœ¨ç”Ÿæˆ NSURLRequest è¯·æ±‚æ—¶è®¾ç½®ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableURLRequest</span> *mutableRequest = [[<span class="built_in">NSMutableURLRequest</span> alloc] initWithURL:url];</span><br><span class="line">mutableRequest.HTTPMethod = method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">   <span class="keyword">if</span> ([<span class="keyword">self</span>.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</span><br><span class="line">       [mutableRequest setValue:[<span class="keyword">self</span> valueForKeyPath:keyPath] forKey:keyPath];</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åˆå§‹åŒ–-2"><a href="#åˆå§‹åŒ–-2" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.stringEncoding = <span class="built_in">NSUTF8StringEncoding</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.mutableHTTPRequestHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line"></span><br><span class="line">    <span class="meta">#1: è®¾ç½® Accept-Languageï¼ŒUser-Agentç­‰ã€‚å¿½ç•¥</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// HTTP Method Definitions; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html</span></span><br><span class="line">    <span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI = [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"GET"</span>, <span class="string">@"HEAD"</span>, <span class="string">@"DELETE"</span>, <span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.mutableObservedChangedKeyPaths = [<span class="built_in">NSMutableSet</span> set];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="built_in">NSSelectorFromString</span>(keyPath)]) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addObserver:<span class="keyword">self</span> forKeyPath:keyPath options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:AFHTTPRequestSerializerObserverContext];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æåˆ°åˆ° KVO ç›‘å¬å±æ€§å˜åŒ–ï¼Œå°±æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™åšçš„ï¼Œç¡®ä¿å®ƒä»¬åœ¨æ”¹å˜åæ›´æ–° NSMutableURLRequest ä¸­å¯¹åº”çš„å±æ€§ã€‚</p>
<p>åˆå§‹åŒ–å®Œæˆåï¼Œå¦‚æœè°ƒç”¨æ™®é€šçš„è¯·æ±‚æ–¹æ³•ï¼Œå°±ä¼šè¿›å…¥è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestWithMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                 URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                parameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                     error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ£€æµ‹å‚æ•°</span></span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(method);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(URLString);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆurl</span></span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:URLString];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(url);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [[<span class="built_in">NSMutableURLRequest</span> alloc] initWithURL:url];</span><br><span class="line">    <span class="comment">// è®¾ç½®è¯·æ±‚æ–¹å¼</span></span><br><span class="line">    mutableRequest.HTTPMethod = method;</span><br><span class="line">    <span class="comment">// è®¾ç½®kVOç›‘å¬çš„è¯·æ±‚å±æ€§</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</span><br><span class="line">            [mutableRequest setValue:[<span class="keyword">self</span> valueForKeyPath:keyPath] forKey:keyPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½® HTTP è¯·æ±‚å¤´å’Œè¯·æ±‚å‚æ•°</span></span><br><span class="line">    mutableRequest = [[<span class="keyword">self</span> requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> mutableRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ <strong>- [AFHTTPRequestSerializer requestBySerializingRequest:withParameters:error:]</strong> æ–¹æ³•ï¼Œè®¾ç½® HTTP è¯·æ±‚å¤´å’Œè¯·æ±‚å‚æ•°ï¼š<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               withParameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                        error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(request);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [request mutableCopy];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è¯·æ±‚å¤´</span></span><br><span class="line">    [<span class="keyword">self</span>.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(<span class="keyword">id</span> field, <span class="keyword">id</span> value, <span class="built_in">BOOL</span> * __unused stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> (![request valueForHTTPHeaderField:field]) &#123;</span><br><span class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *query = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (parameters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.queryStringSerialization) &#123;</span><br><span class="line">            <span class="built_in">NSError</span> *serializationError;</span><br><span class="line">            query = <span class="keyword">self</span>.queryStringSerialization(request, parameters, &amp;serializationError);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">                <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                    *error = serializationError;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="keyword">self</span>.queryStringSerializationStyle) &#123;</span><br><span class="line">                <span class="keyword">case</span> AFHTTPRequestQueryStringDefaultStyle:</span><br><span class="line">                    <span class="comment">// æŠŠè¯·æ±‚å‚æ•°è½¬æ¢ä¸º &amp;æ‹¼æ¥çš„å­—ç¬¦ä¸²</span></span><br><span class="line">                    query = AFQueryStringFromParameters(parameters);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ `GET`ï¼Œ`HEAD` å’Œ `DELETE`çš„è¯·æ±‚ï¼Œè¯·æ±‚å‚æ•°æ‹¼æ¥åˆ°URLåé¢</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (query &amp;&amp; query.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mutableRequest.URL = [<span class="built_in">NSURL</span> URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? <span class="string">@"&amp;%@"</span> : <span class="string">@"?%@"</span>, query]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// #2864: an empty string is a valid x-www-form-urlencoded payload</span></span><br><span class="line">        <span class="keyword">if</span> (!query) &#123;</span><br><span class="line">            query = <span class="string">@""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="string">@"Content-Type"</span>]) &#123;</span><br><span class="line">            [mutableRequest setValue:<span class="string">@"application/x-www-form-urlencoded"</span> forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¯·æ±‚å‚æ•°æ”¾å…¥è¯·æ±‚ä½“</span></span><br><span class="line">        [mutableRequest setHTTPBody:[query dataUsingEncoding:<span class="keyword">self</span>.stringEncoding]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mutableRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol>
<li>AFURLResponseSerialization è´Ÿè´£å¯¹è¿”å›çš„æ•°æ®è¿›è¡Œåºåˆ—åŒ–</li>
<li>AFURLRequestSerialization è´Ÿè´£ç”Ÿæˆ NSMutableURLRequestï¼Œä¸ºè¯·æ±‚è®¾ç½® HTTP è¯·æ±‚å¤´å’Œè¯·æ±‚å‚æ•°ï¼Œç®¡ç†å‘å‡ºçš„è¯·æ±‚</li>
</ol>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><ul>
<li><a href="https://github.com/AFNetworking/AFNetworking" target="_blank" rel="noopener">AFNetworking</a></li>
<li><a href="http://www.cnblogs.com/polobymulberry/p/5174298.html" target="_blank" rel="noopener">AFNetworkingæºç é˜…è¯»ï¼ˆå…­ï¼‰</a></li>
<li><a href="https://github.com/Draveness/iOS-Source-Code-Analyze/blob/master/contents/AFNetworking/%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94%20AFURLSerialization%EF%BC%88%E4%B8%89%EF%BC%89.md#afurlresponseserialization" target="_blank" rel="noopener">å¤„ç†è¯·æ±‚å’Œå“åº” AFURLSerializationï¼ˆä¸‰ï¼‰</a></li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Source-Code-Analyze/">Source Code Analyze</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/AFNetworking/">AFNetworking</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://piglikeyoung.com/2017/01/08/AFNetworking-AFURLSerialization-4/" data-title="AFURLSerialization è§£æï¼ˆå››ï¼‰ | Pixar&#39;Filed" data-tsina class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev">
 <a href="/2017/01/26/AFNetworking-AFSecurityPolicy-5/" title="AFSecurityPolicy ç½‘ç»œå®‰å…¨ç­–ç•¥ï¼ˆäº”ï¼‰">
  <strong>ä¸Šä¸€ç¯‡ï¼š</strong><br>
  <span>
  AFSecurityPolicy ç½‘ç»œå®‰å…¨ç­–ç•¥ï¼ˆäº”ï¼‰</span>
</a>
</div>


<div class="next">
<a href="/2016/12/31/AFNetworking-AFNetworkReachabilityManager-3/" title="AFNetworkReachabilityManager ç›‘å¬ç½‘ç»œçŠ¶æ€ï¼ˆä¸‰ï¼‰">
 <strong>ä¸‹ä¸€ç¯‡ï¼š</strong><br> 
 <span>AFNetworkReachabilityManager ç›‘å¬ç½‘ç»œçŠ¶æ€ï¼ˆä¸‰ï¼‰
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="éšè—ä¾§è¾¹æ "></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github åç‰‡</p>
<div class="github-card" data-github="piglikeyoung" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js"></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">åˆ†ç±»</p>
		<ul>
		
		  
			<li><a href="/categories/ARTS/" title="ARTS">ARTS</a></li>
		  
		
		  
			<li><a href="/categories/ReactNative/" title="ReactNative">ReactNative</a></li>
		  
		
		  
			<li><a href="/categories/Source-Code-Analyze/" title="Source Code Analyze">Source Code Analyze</a></li>
		  
		
		  
			<li><a href="/categories/Tips/" title="Tips">Tips</a></li>
		  
		
		  
			<li><a href="/categories/ä¸ªäººæ€»ç»“/" title="ä¸ªäººæ€»ç»“">ä¸ªäººæ€»ç»“</a></li>
		  
		
		  
			<li><a href="/categories/æ‹¿æ¥ä¸»ä¹‰/" title="æ‹¿æ¥ä¸»ä¹‰">æ‹¿æ¥ä¸»ä¹‰</a></li>
		  
		
		  
			<li><a href="/categories/èƒ½å·¥å·§åŒ /" title="èƒ½å·¥å·§åŒ ">èƒ½å·¥å·§åŒ </a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">æ ‡ç­¾</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/RN/" title="RN">RN<sup>6</sup></a></li>
			
		
			
				<li><a href="/tags/AFNetworking/" title="AFNetworking">AFNetworking<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/GCD/" title="GCD">GCD<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/ARTS/" title="ARTS">ARTS<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Moya/" title="Moya">Moya<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/CALayer/" title="CALayer">CALayer<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/Block/" title="Block">Block<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/åŸºç¡€æ•°æ®ç±»å‹/" title="åŸºç¡€æ•°æ®ç±»å‹">åŸºç¡€æ•°æ®ç±»å‹<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/NSTimer/" title="NSTimer">NSTimer<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Objective-C-é”/" title="Objective-C é”">Objective-C é”<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Debug/" title="Debug">Debug<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/Swift/" title="Swift">Swift<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/iTerm2/" title="iTerm2">iTerm2<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Cocoapods/" title="Cocoapods">Cocoapods<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Charles/" title="Charles">Charles<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ä¸ªäººæ€»ç»“/" title="ä¸ªäººæ€»ç»“">ä¸ªäººæ€»ç»“<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/æ­£åˆ™è¡¨è¾¾å¼/" title="æ­£åˆ™è¡¨è¾¾å¼">æ­£åˆ™è¡¨è¾¾å¼<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/æ•ˆç‡/" title="æ•ˆç‡">æ•ˆç‡<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Bug/" title="Bug">Bug<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/æœ¬åœ°åŒ–/" title="æœ¬åœ°åŒ–">æœ¬åœ°åŒ–<sup>1</sup></a></li>
			
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer">
	
	
	<div class="social-font">
		
		
		<a href="https://github.com/piglikeyoung" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
	</div>
			
		
		<p class="copyright" style="margin-top: 10px;">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> Â© 2019
		
		<a href="/about" target="_blank" title="Pixar">Pixar</a>
		

		</p>

</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="å¾®ä¿¡"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="äººäºº"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="å¾®åš"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'http-piglikeyoung-com';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>








<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-83614750-2', 'piglikeyoung.com');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e0d12b30d56e338d16108aaf07bafde8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="è¿”å›é¡¶éƒ¨"><img src="/img/scrollup.png"></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
